<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Urusetia Jualan - Official Chat</title>
    <style>
        /* --- 1. GLOBAL VARIABLES & RESET --- */
        :root {
            --wa-teal-header: #008069;
            --wa-teal-dark: #075E54;
            --wa-bg: #EFE7DE;
            --wa-user-msg: #d9fdd3; /* Hijau Moden WhatsApp */
            --wa-bot-msg: #ffffff;
            --wa-blue-tick: #53bdeb;
            --wa-check-grey: #999999;
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #111; /* Latar belakang desktop gelap */
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            height: 100dvh; /* Dynamic Viewport Height untuk Mobile */
            overflow: hidden;
        }

        /* --- 2. LAYOUT CONTAINER --- */
        .chat-container {
            width: 100%;
            max-width: 450px; /* Lebar standard mobile */
            height: 100%;
            background-color: var(--wa-bg);
            background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png'); /* Official Doodle */
            background-blend-mode: overlay;
            background-size: 400px;
            display: flex;
            flex-direction: column;
            position: relative;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }

        /* --- 3. HEADER --- */
        .chat-header {
            background-color: var(--wa-teal-header);
            color: white;
            padding: 10px 16px;
            display: flex;
            align-items: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
            z-index: 100;
            flex-shrink: 0;
        }

        .profile-pic {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 12px;
            background: #fff url('https://cdn-icons-png.flaticon.com/512/4712/4712035.png') center/cover;
            flex-shrink: 0;
        }

        .header-info {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .header-info h2 {
            margin: 0;
            font-size: 16px;
            font-weight: 500;
            line-height: 1.2;
        }

        .header-info .status {
            font-size: 13px;
            color: #e0e0e0;
            margin-top: 2px;
            min-height: 16px; /* Reserve space */
            transition: opacity 0.3s ease;
        }

        /* --- 4. CHAT AREA --- */
        .chat-box {
            flex: 1;
            overflow-y: auto;
            padding: 10px 5%;
            padding-bottom: 20px;
            display: flex;
            flex-direction: column;
            scroll-behavior: smooth;
        }

        /* Scrollbar cantik */
        .chat-box::-webkit-scrollbar {
            width: 6px;
        }
        .chat-box::-webkit-scrollbar-thumb {
            background-color: rgba(0,0,0,0.2);
            border-radius: 3px;
        }

        /* --- 5. MESEJ BUBBLES --- */
        .message {
            max-width: 80%;
            padding: 6px 7px 8px 9px;
            border-radius: 7.5px;
            margin-bottom: 8px;
            position: relative;
            font-size: 14.5px;
            line-height: 19px;
            color: #111;
            box-shadow: 0 1px 0.5px rgba(0,0,0,0.13);
            word-wrap: break-word;
            animation: popIn 0.3s cubic-bezier(0.25, 1, 0.5, 1);
        }

        @keyframes popIn {
            from { opacity: 0; transform: translateY(10px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        .message strong {
            font-weight: 600;
        }
        
        .message a {
            color: #027eb5;
            text-decoration: none;
        }

        .message img {
            max-width: 100%;
            border-radius: 6px;
            margin-top: 5px;
            margin-bottom: 2px;
        }

        /* Bot (Kiri) */
        .bot-message {
            align-self: flex-start;
            background-color: var(--wa-bot-msg);
            border-top-left-radius: 0;
        }
        .bot-message::before {
            content: "";
            position: absolute;
            top: 0; left: -8px;
            width: 0; height: 0;
            border: 8px solid transparent;
            border-top-color: var(--wa-bot-msg);
            border-right-color: var(--wa-bot-msg); 
            border-bottom: 0;
        }

        /* User (Kanan) */
        .user-message {
            align-self: flex-end;
            background-color: var(--wa-user-msg);
            border-top-right-radius: 0;
        }
        .user-message::before {
            content: "";
            position: absolute;
            top: 0; right: -8px;
            width: 0; height: 0;
            border: 8px solid transparent;
            border-top-color: var(--wa-user-msg);
            border-left-color: var(--wa-user-msg);
            border-bottom: 0;
        }

        /* Metadata (Masa & Tick) */
        .msg-meta {
            display: inline-block;
            float: right;
            margin-left: 10px;
            margin-top: 4px;
            margin-right: -4px;
            margin-bottom: -5px;
            display: flex;
            align-items: flex-end;
            opacity: 0.6;
        }

        .timestamp {
            font-size: 11px;
            margin-right: 3px;
        }

        .tick-icon {
            width: 16px;
            height: 11px; /* Diubahsuai supaya svg fit */
            background-repeat: no-repeat;
            background-position: center;
            background-size: contain;
        }

        /* --- 6. TYPING INDICATOR (Inside Chat) --- */
        .typing-bubble {
            background-color: #fff;
            padding: 8px 12px;
            border-radius: 0 15px 15px 15px;
            width: fit-content;
            margin-bottom: 10px;
            margin-left: 10px;
            box-shadow: 0 1px 1px rgba(0,0,0,0.1);
            position: relative;
            display: none; /* Hidden by default */
            align-items: center;
            gap: 4px;
            align-self: flex-start;
        }
        
        .typing-bubble::before {
            content: "";
            position: absolute;
            top: 0; left: -8px;
            width: 0; height: 0;
            border: 8px solid transparent;
            border-top-color: #fff;
            border-right-color: #fff; 
            border-bottom: 0;
        }

        .dot {
            width: 6px;
            height: 6px;
            background-color: #b9b9b9;
            border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out both;
        }

        .dot:nth-child(1) { animation-delay: -0.32s; }
        .dot:nth-child(2) { animation-delay: -0.16s; }

        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }

        /* --- 7. INPUT AREA --- */
        .input-area {
            background-color: #f0f0f0;
            padding: 6px 10px;
            min-height: 62px;
            display: flex;
            align-items: flex-end; /* Align bottom */
            gap: 8px;
            padding-bottom: 10px; /* Safe area */
            z-index: 100;
        }

        .input-wrapper {
            flex: 1;
            background: #fff;
            border-radius: 25px;
            display: flex;
            align-items: center;
            padding: 9px 15px;
            box-shadow: 0 1px 0 rgba(0,0,0,0.05);
        }

        .form-input {
            flex: 1;
            border: none;
            outline: none;
            font-size: 16px; /* Prevent zoom on iOS */
            background: transparent;
            max-height: 100px;
            font-family: inherit;
        }

        .send-btn {
            width: 45px;
            height: 45px;
            background-color: var(--wa-teal-header);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            border: none;
            cursor: pointer;
            flex-shrink: 0;
            box-shadow: 0 1px 2px rgba(0,0,0,0.2);
            transition: transform 0.1s;
        }
        
        .send-btn:active {
            transform: scale(0.95);
        }

        /* --- 8. CUSTOM UI ELEMENTS (Choices/Upload) --- */
        .choice-container {
            display: flex;
            flex-direction: column;
            gap: 8px;
            width: 100%;
            max-width: 300px;
            margin: 5px 0;
        }

        .choice-btn {
            background-color: #fff;
            color: var(--wa-teal-header);
            border: 1px solid #ddd;
            padding: 12px;
            border-radius: 10px;
            font-weight: 500;
            text-align: center;
            cursor: pointer;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            transition: background 0.1s;
        }

        .choice-btn:active {
            background-color: #f5f5f5;
        }

        .choice-btn.primary {
            background-color: #e7ffdb;
            color: #111;
            border: 1px solid #c8e6c9;
        }

        /* New: Cart Summary Style */
        .cart-summary {
            background: #fff;
            border-radius: 10px;
            padding: 10px;
            margin-bottom: 5px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            font-size: 14px;
            border: 1px dashed #ccc;
        }
        
        .cart-item {
            display: flex;
            justify-content: space-between;
            border-bottom: 1px solid #eee;
            padding: 5px 0;
        }
        .cart-item:last-child { border-bottom: none; }

        .finish-section {
            margin-top: 10px;
            border-top: 2px solid #ddd;
            padding-top: 10px;
            text-align: center;
        }
        
        .finish-label {
            font-size: 13px;
            color: #666;
            margin-bottom: 8px;
            font-style: italic;
        }

        /* --- 9. START OVERLAY --- */
        #start-overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 999;
            display: flex;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(2px);
        }
        
        .start-btn {
            background: #fff;
            padding: 15px 30px;
            border-radius: 30px;
            font-weight: bold;
            font-size: 16px;
            color: var(--wa-teal-header);
            border: none;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            cursor: pointer;
        }

        /* --- 10. MODAL POPUP (NEW) --- */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            display: none;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .modal-content {
            background: white;
            width: 100%;
            max-width: 320px;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            text-align: center;
            animation: modalPop 0.3s ease-out;
        }

        @keyframes modalPop {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .modal-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            color: var(--wa-teal-dark);
        }

        .qty-control {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .qty-btn {
            width: 40px; height: 40px;
            border-radius: 50%;
            border: 1px solid #ddd;
            background: #f0f0f0;
            font-size: 20px;
            cursor: pointer;
            display: flex; align-items: center; justify-content: center;
        }

        .qty-input {
            width: 60px;
            text-align: center;
            font-size: 18px;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        
        .custom-size-input {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            display: none; /* Default hidden */
        }

    </style>
</head>
<body>

<!-- Overlay untuk membolehkan Audio (Browser Policy) -->
<div id="start-overlay">
    <button class="start-btn" onclick="startChat()">Mula Chat üí¨</button>
</div>

<!-- NEW: Modal Quantity Selection -->
<div id="qty-modal" class="modal-overlay">
    <div class="modal-content">
        <div id="modal-size-title" class="modal-title">Pilih Kuantiti</div>
        
        <!-- Input Teks untuk "Lain-lain" -->
        <input type="text" id="modal-custom-size" class="custom-size-input" placeholder="Sila taip saiz (cth: 5XL)">

        <div class="qty-control">
            <button class="qty-btn" onclick="adjustQty(-1)">-</button>
            <input type="number" id="modal-qty" class="qty-input" value="1" min="1">
            <button class="qty-btn" onclick="adjustQty(1)">+</button>
        </div>

        <button class="choice-btn primary" onclick="confirmQty()" style="width:100%">‚úÖ Tambah ke Senarai</button>
        <button class="choice-btn" onclick="closeQtyModal()" style="width:100%; margin-top:10px; border:none; color:red;">Batal</button>
    </div>
</div>

<div class="chat-container">
    <!-- Header -->
    <div class="chat-header">
        <!-- Back Button Icon -->
        <span style="margin-right: 10px; font-size: 20px; cursor: pointer;">‚Üê</span>
        
        <div class="profile-pic"></div>
        <div class="header-info">
            <h2>Urusetia Jualan</h2>
            <div id="header-status" class="status">online</div>
        </div>
        
        <!-- Video/Call Icons -->
        <div style="display: flex; gap: 20px; font-size: 18px;">
            <span>üìπ</span>
            <span>üìû</span>
        </div>
    </div>

    <!-- Chat Area -->
    <div class="chat-box" id="chat-box">
        <!-- Mesej akan masuk sini -->
        
        <!-- Elemen Typing (Hidden by default) -->
        <div id="typing-indicator" class="typing-bubble">
            <div class="dot"></div>
            <div class="dot"></div>
            <div class="dot"></div>
        </div>
    </div>

    <!-- Input Area -->
    <div class="input-area" id="input-area">
        <div class="input-wrapper">
            <input type="text" id="text-input" class="form-input" placeholder="Mesej" autocomplete="off">
        </div>
        <button id="main-send-btn" class="send-btn">
            <!-- Send Icon SVG -->
            <svg viewBox="0 0 24 24" width="24" height="24" fill="white">
                <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"></path>
            </svg>
        </button>
    </div>
</div>

<script>
    /* =========================================
       CONFIG & DATA VARIABLES
       ========================================= */
    const GOOGLE_SHEET_URL = 'https://script.google.com/macros/s/AKfycbwU0RSESTNpE8I0fEsTfaTBF5zOccvWLp0iLTvMsXwAcZFONroxNjYMK46zoQKDspVjiQ/exec';
    const CSV_QUESTION_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vS_V0WwvfHF5eIPQsfUQIEQ4y6-sz7O_qxV8WBnucYVAXTxafSBE8QIde604Hjb3XiZZRKMjpfGRHmv/pub?gid=0&single=true&output=csv';
    const IMGBB_API_KEY = '07c44a986353977c2a4907218d19dc1d';
    const DUMMY_QR = 'https://raw.githubusercontent.com/kamarul95-cloud/qrcode/refs/heads/main/IMG-20251105-WA0114.jpg';

    // Audio Assets
    const audioSent = new Audio("https://cdn.pixabay.com/audio/2022/11/25/audio_651a14eb84.mp3"); // Tik
    const audioRecv = new Audio("https://cdn.pixabay.com/audio/2022/03/15/audio_24921ff7c4.mp3"); // Pop
    audioSent.volume = 0.4;
    audioRecv.volume = 0.5;

    // State
    let step = 1;
    let questions = [];
    let userData = { name: "", sizeQty: [], phone: "" };
    let orderId = "";
    let isProcessing = false;
    let uploadedReceiptUrl = "Belum diterima";
    
    // Temp State untuk Modal & Pukal
    let selectedSizeTemp = "";
    let choicesWrapperTemp = null;
    let tempCart = []; // Simpan list sementara sebelum confirm

    // DOM Elements
    const chatBox = document.getElementById('chat-box');
    const inputArea = document.getElementById('input-area');
    const textInput = document.getElementById('text-input');
    const sendBtn = document.getElementById('main-send-btn');
    const statusDiv = document.getElementById('header-status');
    const typingBubble = document.getElementById('typing-indicator');

    /* =========================================
       UTILITY FUNCTIONS
       ========================================= */
    
    function startChat() {
        document.getElementById('start-overlay').style.display = 'none';
        audioSent.play().then(() => {
            audioSent.pause();
            audioSent.currentTime = 0;
        }).catch(e => console.log("Audio unlock failed", e));
        initBot();
    }

    function playSound(type) {
        if(type === 'sent') {
            audioSent.currentTime = 0;
            audioSent.play().catch(e => {});
        } else {
            audioRecv.currentTime = 0;
            audioRecv.play().catch(e => {});
        }
    }

    function getTime() {
        const now = new Date();
        let h = now.getHours();
        const m = now.getMinutes();
        const ampm = h >= 12 ? 'PM' : 'AM';
        h = h % 12;
        h = h ? h : 12;
        return `${h}:${m < 10 ? '0'+m : m} ${ampm}`;
    }

    function scrollToBottom() {
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    // --- FUNGSI BARU: Force Download ---
    async function forceDownload(url, filename) {
        try {
            const response = await fetch(url);
            const blob = await response.blob();
            const blobUrl = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = blobUrl;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            
            // Cleanup memory
            setTimeout(() => URL.revokeObjectURL(blobUrl), 100);
            
        } catch (e) {
            console.error('Force download failed, fallback to new tab', e);
            window.open(url, '_blank');
        }
    }

    /* =========================================
       UI INTERACTION FUNCTIONS
       ========================================= */

    function setBotStatus(isTyping) {
        if(isTyping) {
            statusDiv.innerText = "typing...";
            statusDiv.style.color = "#25D366"; 
            typingBubble.style.display = "flex";
            scrollToBottom();
        } else {
            statusDiv.innerText = "online";
            statusDiv.style.color = "#e0e0e0";
            typingBubble.style.display = "none";
        }
    }

    async function addMessage(text, sender, delay = 0) {
        return new Promise(resolve => {
            setTimeout(() => {
                const msgDiv = document.createElement('div');
                msgDiv.className = `message ${sender === 'user' ? 'user-message' : 'bot-message'}`;
                
                let content = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                content = content.replace(/\n/g, '<br>');

                const blueTickSvg = `<svg viewBox="0 0 16 11" width="16" height="11"><path fill="#53bdeb" d="M10.854 6.726l.732.723-4.832 4.777L2.096 7.62l.732-.723 3.926 3.878 4.1-4.05zm5.106-2.073l-5.694 5.63-1.425-1.408.732-.723 3.967 3.92L15.228 3.93l.732.723z"/></svg>`;
                
                const metaHtml = `
                    <div class="msg-meta">
                        <span class="timestamp">${getTime()}</span>
                        ${sender === 'user' ? `<span class="tick-icon">${blueTickSvg}</span>` : ''}
                    </div>
                `;

                msgDiv.innerHTML = content + metaHtml;
                chatBox.insertBefore(msgDiv, typingBubble);
                playSound(sender === 'user' ? 'sent' : 'recv');
                scrollToBottom();
                resolve();
            }, delay);
        });
    }

    /* =========================================
       CORE LOGIC
       ========================================= */

    async function initBot() {
        try {
            questions = await fetchQuestions(); 
            if(questions.length === 0) {
                console.warn("Gagal tarik CSV, guna fallback data.");
                questions = [
                    {Field_ID: '1', Question: "Hai! Selamat datang ke Urusetia Jualan. Boleh saya tahu nama anda?", Type: 'text'},
                    {Field_ID: '2', Question: "Hi **{{name}}**. Sila pilih saiz baju yang anda mahu.", Type: 'choices', Options: "XS, S, M, L, XL, 2XL, 3XL, Lain-lain"},
                    {Field_ID: '3', Question: "Baik. Boleh berikan nombor telefon untuk dihubungi?", Type: 'text'},
                    {Field_ID: '4', Question: "Sila buat pembayaran ke akaun tertera.", Type: 'image', Options: DUMMY_QR},
                    {Field_ID: '5', Question: "Sila upload resit pembayaran anda.", Type: 'upload'},
                    {Field_ID: '6', Question: "Sila sahkan butiran tempahan anda.", Type: 'confirm'}
                ];
            }
            processStep();
        } catch (e) {
            console.error(e);
            addMessage("Maaf, sistem sedang offline. Sila refresh.", 'bot');
        }
    }

    async function processStep() {
        if(isProcessing) return;
        isProcessing = true;
        
        textInput.value = '';
        textInput.disabled = false;
        textInput.focus();
        
        const existingChoices = document.querySelectorAll('.choice-container-wrapper');
        existingChoices.forEach(el => el.remove());

        const currentQ = questions.find(q => q.Field_ID == step);

        if (!currentQ && step > questions.length) {
            setBotStatus(true);
            await new Promise(r => setTimeout(r, 1500));
            setBotStatus(false);
            await addMessage(`Terima kasih **${userData.name}**. Tempahan anda (ID: ${orderId}) telah direkod.`, 'bot');
            
            const waMsg = `Hi Syamil, saya ${userData.name} (ID: ${orderId}) ingin bertanya status tempahan.`;
            const waLink = `https://wa.me/60105272343?text=${encodeURIComponent(waMsg)}`;
            const btnHtml = `<div class="choice-container-wrapper" style="display:flex; justify-content:center; margin-top:10px;"><a href="${waLink}" target="_blank" class="choice-btn primary" style="text-decoration:none; width:80%;">Hubungi Admin (WhatsApp)</a></div>`;
            chatBox.innerHTML += btnHtml;
            scrollToBottom();
            isProcessing = false;
            return;
        }

        setBotStatus(true);
        await new Promise(r => setTimeout(r, 1200 + Math.random()*500)); 
        setBotStatus(false);

        let qText = currentQ.Question.replace("{{name}}", userData.name);
        
        // --- LOGIK QR CODE DIKEMASKINI ---
        if(currentQ.Type === 'image') {
            await addMessage(qText, 'bot');
            const imgUrl = currentQ.Options || DUMMY_QR;
            
            // 1. Tunjuk Imej
            await addMessage(`<img src="${imgUrl}" alt="QR Code">`, 'bot', 200);

            // 2. Tunjuk Butang Download (Guna appendChild supaya tak kacau urutan)
            const dlWrapper = document.createElement('div');
            dlWrapper.className = 'choice-container-wrapper';
            dlWrapper.style.cssText = "display:flex; justify-content:center; margin-top:5px; margin-bottom:10px;";
            
            dlWrapper.innerHTML = `
                <button class="choice-btn" style="text-decoration:none; display:flex; align-items:center; gap:5px; color:#111; cursor:pointer;" onclick="forceDownload('${imgUrl}', 'QR_Pembayaran.jpg')">
                   <span>‚¨áÔ∏è</span> Muat Turun QR
                </button>
            `;
            
            chatBox.insertBefore(dlWrapper, typingBubble);
            scrollToBottom();

            // 3. Tunjuk Arahan Seterusnya
            await addMessage("Sila muat naik resit pembayaran anda di bawah.", 'bot', 800);
            
            // 4. Render Butang Upload
            renderUploadUI();
            
            isProcessing = false;
            return;
        }

        if(currentQ.Type === 'confirm') {
             const summary = `
Nama: ${userData.name}<br>
Tel: ${userData.phone}<br>
Saiz: ${userData.sizeQty.map(s => `${s.size} (x${s.qty})`).join(', ')}<br>
Resit: ${uploadedReceiptUrl.includes('http') ? '‚úÖ Diterima' : '‚ùå Tiada'}
`;
            await addMessage(qText, 'bot');
            await addMessage(summary, 'bot', 300);
            renderConfirmUI();
            isProcessing = false;
            return;
        }

        await addMessage(qText, 'bot');

        if(currentQ.Type === 'choices') {
            tempCart = []; 
            renderChoicesUI(currentQ.Options.split(','));
            textInput.disabled = true; 
        } else {
            sendBtn.onclick = handleTextInput;
            textInput.onkeypress = (e) => { if(e.key === 'Enter') handleTextInput(); };
        }
        
        isProcessing = false;
    }

    function handleTextInput() {
        const val = textInput.value.trim();
        if(!val) return;

        if(step === 1 && val.length < 3) { alert("Nama terlalu pendek"); return; }
        if(step === 3 && val.length < 9) { alert("Nombor telefon tidak sah"); return; }

        if(step === 1) userData.name = val;
        if(step === 3) userData.phone = val;

        addMessage(val, 'user');
        textInput.value = '';
        step++;
        processStep();
    }

    /* =========================================
       LOGIC PILIHAN SAIZ (PUKAL) YANG BARU
       ========================================= */

    function renderChoicesUI(options) {
        // Wrapper Utama
        const wrapper = document.createElement('div');
        wrapper.className = 'choice-container-wrapper';
        wrapper.style.cssText = "display: flex; flex-direction: column; align-items: flex-end; margin-bottom: 10px; width: 100%;";
        
        // 1. Container Senarai Cart (Kosong Mula2)
        const cartDiv = document.createElement('div');
        cartDiv.id = 'temp-cart-display';
        cartDiv.className = 'choice-container';
        cartDiv.style.width = '100%'; 
        cartDiv.style.display = 'none'; // Sembunyi jika kosong
        cartDiv.innerHTML = `<div class="cart-summary"><strong style="color:var(--wa-teal-header)">Senarai Pilihan:</strong><div id="cart-items-list"></div></div>`;
        
        // 2. Container Butang Saiz
        const btnsContainer = document.createElement('div');
        btnsContainer.className = 'choice-container';
        
        options = options.map(o => o.trim()).filter(o => o);
        options.forEach(opt => {
            const btn = document.createElement('div');
            btn.className = 'choice-btn';
            btn.innerText = opt;
            btn.onclick = () => openQtyModal(opt, wrapper); 
            btnsContainer.appendChild(btn);
        });

        // 3. Container Butang Selesai (Section Soalan "Ada lagi?")
        const finishDiv = document.createElement('div');
        finishDiv.id = 'finish-section-ui';
        finishDiv.className = 'choice-container';
        finishDiv.style.width = '100%';
        finishDiv.style.display = 'none'; // Sembunyi sampai ada 1 item
        
        finishDiv.innerHTML = `
            <div class="finish-section">
                <div class="finish-label">Adakah anda ingin menambah saiz lain?</div>
                <div style="display:flex; gap:10px;">
                    <div style="flex:1; text-align:center; font-size:12px; color:#999; padding-top:10px;">(Pilih butang saiz di atas üëÜ)</div>
                    <button class="choice-btn primary" onclick="finishSizeSelection(this)" style="flex:1;">‚úÖ Selesai, Teruskan</button>
                </div>
            </div>
        `;

        wrapper.appendChild(cartDiv);
        wrapper.appendChild(btnsContainer);
        wrapper.appendChild(finishDiv);
        
        chatBox.insertBefore(wrapper, typingBubble); 
        scrollToBottom();
        
        choicesWrapperTemp = wrapper; // Simpan ref utk update nanti
    }

    function openQtyModal(size, wrapperElement) {
        selectedSizeTemp = size;
        document.getElementById('modal-size-title').innerText = `Saiz: ${size}`;
        document.getElementById('modal-qty').value = 1;

        if (size.toLowerCase().includes('lain')) {
            document.getElementById('modal-custom-size').style.display = 'block';
            document.getElementById('modal-custom-size').value = '';
            document.getElementById('modal-custom-size').focus();
        } else {
            document.getElementById('modal-custom-size').style.display = 'none';
        }
        document.getElementById('qty-modal').style.display = 'flex';
    }

    function closeQtyModal() {
        document.getElementById('qty-modal').style.display = 'none';
    }

    function adjustQty(amount) {
        const input = document.getElementById('modal-qty');
        let val = parseInt(input.value) + amount;
        if(val < 1) val = 1;
        input.value = val;
    }

    function confirmQty() {
        let size = selectedSizeTemp;
        const qty = parseInt(document.getElementById('modal-qty').value);
        
        if (size.toLowerCase().includes('lain')) {
            const customInput = document.getElementById('modal-custom-size').value.trim();
            if (!customInput) {
                alert("Sila tulis saiz yang anda mahu.");
                return;
            }
            size = customInput; 
        }

        if (isNaN(qty) || qty < 1) return;

        // 1. Simpan dalam Cart Sementara (Temp)
        tempCart.push({ size: size, qty: qty });
        
        // 2. Tutup Modal
        closeQtyModal();
        
        // 3. Kemaskini UI Cart di Chat (JANGAN hantar mesej lagi)
        updateCartDisplay();
    }

    function updateCartDisplay() {
        if(!choicesWrapperTemp) return;
        
        const cartDisplay = choicesWrapperTemp.querySelector('#temp-cart-display');
        const cartList = choicesWrapperTemp.querySelector('#cart-items-list');
        const finishUi = choicesWrapperTemp.querySelector('#finish-section-ui');

        // Tunjuk UI Cart & Butang Selesai
        cartDisplay.style.display = 'block';
        finishUi.style.display = 'flex';

        // Render List item
        cartList.innerHTML = tempCart.map((item, idx) => `
            <div class="cart-item">
                <span><b>${item.size}</b> (x${item.qty})</span>
                <span style="color:red; cursor:pointer;" onclick="removeItem(${idx})">‚úï</span>
            </div>
        `).join('');

        scrollToBottom();
    }

    function removeItem(index) {
        tempCart.splice(index, 1);
        
        // Jika kosong, sembunyi balik UI
        if(tempCart.length === 0) {
            const cartDisplay = choicesWrapperTemp.querySelector('#temp-cart-display');
            const finishUi = choicesWrapperTemp.querySelector('#finish-section-ui');
            cartDisplay.style.display = 'none';
            finishUi.style.display = 'none';
        } else {
            updateCartDisplay();
        }
    }

    function finishSizeSelection(btnElement) {
        if(tempCart.length === 0) return;
        
        // Disable UI
        choicesWrapperTemp.querySelectorAll('.choice-btn').forEach(b => b.onclick = null);
        choicesWrapperTemp.style.opacity = '0.7';

        // 1. Simpan ke Global UserData
        userData.sizeQty = [...tempCart];

        // 2. Format Mesej "Pukal"
        const summaryMsg = "Saya nak saiz: " + tempCart.map(i => `${i.size}(${i.qty})`).join(', ');
        
        // 3. Hantar Mesej User
        addMessage(summaryMsg, 'user');

        // 4. Move Next Step
        step++;
        processStep();
    }

    /* =========================================
       UPLOAD & CONFIRMATION
       ========================================= */

    function renderUploadUI() {
        const wrapper = document.createElement('div');
        wrapper.className = 'choice-container-wrapper';
        wrapper.style.cssText = "padding: 10px; background: white; border-radius: 10px; margin: 10px 20px; text-align: center; box-shadow: 0 1px 3px rgba(0,0,0,0.1);";
        
        wrapper.innerHTML = `
            <input type="file" id="file-upload" accept="image/*" style="display:none">
            <button class="choice-btn primary" style="width:100%" onclick="document.getElementById('file-upload').click()">üìÅ Pilih Resit & Hantar</button>
            <button class="choice-btn" style="width:100%; margin-top:5px; border:none; color:#999;" onclick="skipUpload()">Skip / Bayar Nanti</button>
        `;

        chatBox.insertBefore(wrapper, typingBubble);
        scrollToBottom();

        document.getElementById('file-upload').onchange = async (e) => {
            const file = e.target.files[0];
            if(!file) return;
            
            wrapper.remove(); 
            addMessage(`Menghantar resit: ${file.name}...`, 'user');
            
            setBotStatus(true);
            const url = await uploadToImgBB(file);
            setBotStatus(false);
            
            if(url) {
                uploadedReceiptUrl = url;
                await addMessage(`‚úÖ Resit diterima.`, 'bot');
            } else {
                await addMessage(`‚ö†Ô∏è Gagal upload. Kami akan hubungi anda nanti.`, 'bot');
            }
            
            step = 6; 
            processStep();
        };
    }
    
    function skipUpload() {
        document.querySelector('.choice-container-wrapper').remove();
        addMessage("Saya akan bayar kemudian.", 'user');
        step = 6;
        processStep();
    }

    function renderConfirmUI() {
        const wrapper = document.createElement('div');
        wrapper.className = 'choice-container-wrapper';
        wrapper.style.cssText = "display: flex; gap: 10px; justify-content: center; margin: 10px;";
        
        wrapper.innerHTML = `
            <button class="choice-btn primary" onclick="finishOrder(true, this.parentElement)">Sahkan ‚úÖ</button>
            <button class="choice-btn" style="color:red;" onclick="finishOrder(false, this.parentElement)">Edit ‚ùå</button>
        `;
        
        chatBox.insertBefore(wrapper, typingBubble);
        scrollToBottom();
    }

    async function finishOrder(confirmed, uiElement) {
        uiElement.remove();
        if(confirmed) {
            addMessage("Ya, maklumat betul.", 'user');
            setBotStatus(true);
            
            orderId = "ORD-" + Math.floor(Math.random() * 10000);
            
            const success = await sendToSheet();
            setBotStatus(false);
            
            step = 99; 
            processStep();
        } else {
            addMessage("Saya nak edit semula.", 'user');
            step = 1;
            userData = { name: "", sizeQty: [], phone: "" };
            processStep();
        }
    }

    /* =========================================
       API HELPERS
       ========================================= */

    async function fetchQuestions() {
        try {
            const res = await fetch(CSV_QUESTION_URL);
            const csvText = await res.text();
            
            const lines = csvText.split('\n').filter(line => line.trim() !== '');
            if (lines.length < 2) throw new Error("Tiada data");
            
            const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
            
            return lines.slice(1).map(line => {
                const values = line.match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g) || [];
                const cleanValues = values.map(val => val.trim().replace(/"/g, ''));
                let obj = {};
                headers.forEach((h, i) => obj[h] = cleanValues[i] || '');
                return obj;
            }).filter(item => item.Field_ID && item.Field_ID.match(/^\d+$/)); 

        } catch(e) { 
            console.error("CSV Fetch Error:", e);
            return []; 
        }
    }

    async function uploadToImgBB(file) {
        const formData = new FormData();
        formData.append("image", file);
        try {
            const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, { method: 'POST', body: formData });
            const data = await res.json();
            return data.data.url;
        } catch(e) { return null; }
    }

    async function sendToSheet() {
        const sizeCounts = {
            'XS': 0, 'S': 0, 'M': 0, 'L': 0, 
            'XL': 0, '2XL': 0, '3XL': 0
        };
        let customSizes = [];
        let totalQty = 0;

        userData.sizeQty.forEach(item => {
            if (sizeCounts.hasOwnProperty(item.size.toUpperCase())) {
                sizeCounts[item.size.toUpperCase()] += item.qty;
            } else {
                customSizes.push(`${item.size} (${item.qty})`);
            }
            totalQty += item.qty;
        });

        const payload = {
            'ID Tempahan': orderId,
            'Nama Pelanggan': userData.name,
            'Nombor Telefon': userData.phone,
            'Tarikh Tempahan': new Date().toLocaleString('ms-MY'), 
            
            'Saiz XS': sizeCounts['XS'],
            'Saiz S': sizeCounts['S'],
            'Saiz M': sizeCounts['M'],
            'Saiz L': sizeCounts['L'],
            'Saiz XL': sizeCounts['XL'],
            'Saiz 2XL': sizeCounts['2XL'],
            'Saiz 3XL': sizeCounts['3XL'],
            
            'Saiz Lain (Spesifikasi)': customSizes.join(', ') || '-',
            'Jumlah Kuantiti (Total)': totalQty,
            
            // --- KEMASKINI STATUS PEMBAYARAN DI SINI ---
            'Status Pembayaran': uploadedReceiptUrl.includes('http') ? 'Selesai' : 'Menunggu Pembayaran',
            
            'Nama Fail Resit': uploadedReceiptUrl
        };
        
        console.log("Sending Payload:", payload); 

        try {
            await fetch(GOOGLE_SHEET_URL, {
                method: 'POST', mode: 'no-cors',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });
            return true;
        } catch(e) { return false; }
    }

</script>

</body>
</html>
