<!DOCTYPE html>
<html lang="ms">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Urusetia Jualan - Chatbot WhatsApp</title>
<style>
/* --- GAYA CSS FINAL (Replika Hampir 100% Flowdeck/WhatsApp) --- */
body {
font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; /* Guna font lebih dekat WhatsApp */
background-color: #ECE5DD;
margin: 0;
padding: 0;
display: flex;
justify-content: center;
align-items: flex-end;
min-height: 100vh;
}

.chat-container {
width: 100%;
max-width: 600px;
height: 100vh;
background-color: #ffffff;
display: flex;
flex-direction: column;
overflow: hidden;
box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
position: relative;
}

/* HEADER SAMA SEPERTI WHATSAPP */
.chat-header {
background-color: #075E54;
color: white;
padding: 10px 15px;
font-size: 1.1em;
display: flex;
align-items: center;
box-shadow: 0 1px 3px rgba(0,0,0,0.15);
z-index: 10;
}

.chat-header .profile-pic-placeholder {
width: 40px;
height: 40px;
border-radius: 50%;
background-color: #eee;
margin-right: 10px;
display: flex;
align-items: center;
justify-content: center;
}

.chat-header h2 {
margin: 0;
font-size: 1em;
}

.chat-header .status {
font-size: 0.7em;
color: #a3c4ab;
margin-top: 2px;
}

/* CHAT BOX (MESSAGE AREA) */
.chat-box {
padding: 10px;
overflow-y: auto;
flex-grow: 1;
background-color: #E6DDD5;

/* === KOD BARU UNTUK WALLPAPER TUNGGAL (TIDAK BERULANG) === */
background-image: url('https://raw.githubusercontent.com/kamarul95-cloud/qrcode/refs/heads/main/IMG-20251111-WA0000.jpg');
background-repeat: no-repeat; /* TIDAK MENGULANG */
background-size: cover; /* MENUTUP SELURUH RUANG CHAT-BOX */
background-position: center; /* Posisikan di tengah */
background-attachment: scroll;
/* ========================================================== */

display: flex;
flex-direction: column;
}

/* BUIH MESEJ (DITAMBAHBAIK UNTUK BENTUK LEBIH BUJUR) */
.message {
max-width: 75%; /* Kurangkan lebar maksimum agar kelihatan lebih bujur */
padding: 6px 9px 8px 9px; /* Padding diubah untuk teks kelihatan lebih padat */
border-radius: 8px;
margin-bottom: 5px; /* Kurangkan margin bawah */
word-wrap: break-word;
clear: both;
box-shadow: 0 1px 0.5px rgba(0, 0, 0, 0.13);
line-height: 1.35; /* Jarak baris dikurangkan */
position: relative;
font-size: 0.95em; /* Saiz fon sedikit kecil */
}

/* Mesej Bot (Putih - Kiri) */
.bot-message {
background-color: #ffffff;
margin-right: auto;
margin-left: 2px;
border-top-left-radius: 0; /* Corner yang tajam */
}

/* Mesej Pengguna (Hijau Muda - Kanan) */
.user-message {
background-color: #DCF8C6;
margin-left: auto;
margin-right: 2px;
border-top-right-radius: 0; /* Corner yang tajam */
text-align: left;
}

/* Gaya untuk imej/QR Code */
.bot-message img {
max-width: 100%;
height: auto;
border-radius: 5px;
margin-top: 5px;
}

.input-area {
padding: 8px;
background-color: #f0f0f0;
display: flex;
flex-wrap: wrap;
gap: 5px;
border-top: 1px solid #eee;
align-items: flex-end; /* BUTANG BERADA DI BAWAH */
}

/* INDIKATOR MENAIP */
#typing-indicator {
margin: 0 10px 7px 10px;
display: flex;
align-items: center;
padding: 9px 12px;
background-color: #ffffff;
border-radius: 8px;
border-bottom-left-radius: 0;
font-style: italic;
color: #555;
box-shadow: 0 1px 0.5px rgba(0, 0, 0, 0.13);
width: fit-content;
}

/* Animasi dot kekal sama */
.dot {
height: 6px;
width: 6px;
background-color: #555;
border-radius: 50%;
display: inline-block;
margin-left: 2px;
animation: bounce 1.2s infinite ease-in-out;
}

.dot:nth-child(2) { animation-delay: 0.4s; }
.dot:nth-child(3) { animation-delay: 0.8s; }

@keyframes bounce {
0%, 80%, 100% { transform: translateY(0); }
40% { transform: translateY(-5px); }
}

/* UNTUK KOTAK TEKS S1 & S3 */
        .input-area input[type="text"] {
            flex-grow: 1; /* Mesti ada untuk mengambil baki ruang */
            padding: 10px 15px; /* Padding yang lebih baik */
            border: none;
            border-radius: 20px;
            box-shadow: none; /* Buang shadow lama */
            background-color: #ffffff; /* Pastikan ia putih */
            min-height: 40px; 
            box-sizing: border-box; 
        }

/* KEMBALIKAN GAYA DEFAULT UNTUK BUTANG PETAK/BUJUR */
.input-area button {
background-color: #075E54; /* Warna default */
color: white;
border: none;
padding: 10px 15px; /* Padding bujur */
border-radius: 20px; /* Bentuk bujur/petak */
cursor: pointer;
font-weight: bold;
transition: background-color 0.2s;
font-size: 0.9em;
/* Reset gaya bulat */
width: auto;
height: auto;
display: inline-block;
}

/* KELAS BAHARU: Hanya untuk butang 'Hantar' bulat */
.send-button-wa {
width: 48px !important;
height: 48px !important;
border-radius: 50% !important; /* Dibuat bulat */
display: flex !important;
justify-content: center !important;
align-items: center !important;
padding: 0 !important;
font-size: 1.5em !important;
background-color: #075E54 !important;
}


/* GAYA BUTANG PILIHAN (Choice Button) KEKAL SAMA */
.choice-button {
margin-top: 5px;
flex: 1 1 48%;
background-color: #f7f7f7 !important;
color: #000 !important;
border: 1px solid #ccc !important;
box-shadow: 0 1px 1px rgba(0,0,0,0.05);
padding: 8px 10px;
font-weight: normal;
text-align: left;
border-radius: 10px !important;
}

@media (max-width: 600px) {
.chat-container {
border-radius: 0;
}
}
</style>‚Äã-
</head>
<body>

<div class="chat-container">
<div class="chat-header">
<div class="profile-pic-placeholder">
<span style="font-size: 20px;">ü§ñ</span>
</div>
<div>
<h2>Urusetia Jualan</h2>
<p class="status">online</p>
</div>
</div>
<div class="chat-box" id="chat-box">
</div>

<div id="typing-indicator" style="display:none;">
Urusetia Jualan sedang menaip
<div class="dot"></div>
<div class="dot"></div>
<div class="dot"></div>
</div>

<div class="input-area" id="input-area">
</div>
</div>

<script>
// üîë KEMAS KINI UTAMA: URL GOOGLE APPS SCRIPT ANDA
const GOOGLE_SHEET_URL = 'https://script.google.com/macros/s/AKfycbwU0RSESTNpE8I0fEsTfaTBF5zOccvWLp0iLTvMsXwAcZFONroxNjYMK46zoQKDspVjiQ/exec';
// üîë KEMAS KINI CSV: URL GOOGLE SHEET CSV YANG DIPERLUKAN
const CSV_QUESTION_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vS_V0WwvfHF5eIPQsfUQIEQ4y6-sz7O_qxV8WBnucYVAXTxafSBE8QIde604Hjb3XiZZRKMjpfGRHmv/pub?gid=0&single=true&output=csv';

// üîë KUNCI API IMGBB ANDA
const IMGBB_API_KEY = '07c44a986353977c2a4907218d19dc1d';

// üì∏ URL Imej QR Code (Jika lajur Options kosong dalam CSV)
const DUMMY_QR_CODE_URL = 'https://raw.githubusercontent.com/kamarul95-cloud/qrcode/refs/heads/main/IMG-20251105-WA0114.jpg';

// ** PEMBOLEH UBAH DATA **
let questions = []; // Array untuk menyimpan soalan dari CSV
let step = 1;
let isProcessing = false;
let orderId = "";
let uploadedReceiptUrl = "Belum diterima";
let userData = {
name: "",
sizeQty: [],
phone: ""
};
const chatBox = document.getElementById('chat-box');
const inputArea = document.getElementById('input-area');
const typingIndicator = document.getElementById('typing-indicator');

// ** FUNGSI MUAT TURUN CSV **

function parseCSV(csvText) {
const lines = csvText.split('\n').filter(line => line.trim() !== '');
if (lines.length < 2) throw new Error("Tiada baris data ditemui.");

// Asingkan headers dan data
const headers = lines[0].split(',').map(header => header.trim().replace(/"/g, ''));
const dataLines = lines.slice(1);
const dataObjects = [];

dataLines.forEach(line => {
// Gunakan regex untuk mengendalikan koma di dalam tanda petikan
const values = line.match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g) || [];

// Bersihkan dan trim nilai
const processedValues = values.map(val => val.trim().replace(/"/g, ''));

if (processedValues.length > 0) {
let obj = {};
headers.forEach((header, i) => {
// Gunakan huruf besar/kecil yang betul seperti dalam header (Field_ID, Question, Type, Options)
obj[header] = processedValues[i] || '';
});

// Hanya ambil objek yang mempunyai Field_ID yang sah (bukan baris kosong/header)
if (obj.Field_ID && obj.Field_ID.match(/^\d+$/)) {
dataObjects.push(obj);
}
}
});

if (dataObjects.length === 0) {
throw new Error("Tiada soalan ditemui. Semak Sheet.");
}

console.log("Soalan berjaya dimuatkan:", dataObjects);
return dataObjects;
}

async function fetchQuestions() {
try {
const res = await fetch(CSV_QUESTION_URL);

if (!res.ok) {
// Cuba URL fallback gviz jika yang utama gagal (Sila tukar ID Dokumen jika perlu)
const docId = CSV_QUESTION_URL.match(/\/d\/(.*?)\/e\//)?.[1] || CSV_QUESTION_URL.match(/\/d\/(.*?)\/pub/)?.[1];
const gvizUrl = `https://docs.google.com/spreadsheets/d/${docId}/gviz/tq?tqx=out:csv&gid=0`;

console.warn(`Fetch URL asal gagal (Status: ${res.status}). Mencuba URL Gviz: ${gvizUrl}`);
const fallbackRes = await fetch(gvizUrl);

if (!fallbackRes.ok) {
throw new Error(`HTTP error! status: ${fallbackRes.status}. Gagal mengambil soalan dari kedua-dua URL.`);
}
const csvText = await fallbackRes.text();
return parseCSV(csvText);
}

const csvText = await res.text();
return parseCSV(csvText);

} catch (error) {
console.error("Fetch error:", error);
alert("Ralat: Gagal mengambil soalan dari Google Sheet. Sila semak konsol.");
return []; // Pulangkan array kosong
}
}


// ** FUNGSI BANTUAN **

function showTypingIndicator() {
typingIndicator.style.display = 'flex';
chatBox.scrollTop = chatBox.scrollHeight;
}

function hideTypingIndicator() {
typingIndicator.style.display = 'none';
}

function addMessage(text, type, delay = 500) {
return new Promise(resolve => {
setTimeout(() => {
const formattedText = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
const msgDiv = document.createElement('div');
msgDiv.classList.add('message', type);
msgDiv.innerHTML = formattedText;
chatBox.appendChild(msgDiv);
chatBox.scrollTop = chatBox.scrollHeight;
resolve();
}, delay);
});
}

/**
* Pra-muat imej di latar belakang untuk loading yang lebih pantas.
*/
function preloadImage(url) {
return new Promise(resolve => {
const img = new Image();
img.onload = () => resolve();
img.onerror = () => resolve();
img.src = url;
});
}

// ** FUNGSI INTEGRASI APPS SCRIPT & IMGBB (Kekal Sama) **
function formatOrderDataForSheet(data) {
const sizeCounts = {
'XS': 0, 'S': 0, 'M': 0, 'L': 0, 'XL': 0, '2XL': 0, '3XL': 0
};
let totalQuantity = 0;
let customSizes = [];

data.sizeQty.forEach(item => {
if (sizeCounts.hasOwnProperty(item.size)) {
sizeCounts[item.size] = item.qty;
} else if (item.size === 'Lain-lain') {
customSizes.push(`${item.customSize} (${item.qty} unit)`);
}
totalQuantity += item.qty;
});

const newOrderId = `JUALAN-${Date.now().toString().slice(-5)}`;
orderId = newOrderId;

const formattedData = {
'ID Tempahan': newOrderId,
'Nama Pelanggan': data.name,
'Nombor Telefon': data.phone,
'Tarikh Tempahan': new Date().toLocaleString('ms-MY'),

'Saiz XS': sizeCounts['XS'],
'Saiz S': sizeCounts['S'],
'Saiz M': sizeCounts['M'],
'Saiz L': sizeCounts['L'],
'Saiz XL': sizeCounts['XL'],
'Saiz 2XL': sizeCounts['2XL'],
'Saiz 3XL': sizeCounts['3XL'],
'Saiz Lain (Spesifikasi)': customSizes.join('; ') || '-',
'Jumlah Kuantiti (Total)': totalQuantity,

'Status Pembayaran': uploadedReceiptUrl === 'Belum diterima' ? 'Menunggu Pembayaran' : 'Selesai',
'Nama Fail Resit': uploadedReceiptUrl
};

return formattedData;
}

async function sendDataToSheet(data) {
console.log("Menghantar data order ke Apps Script:", data);

try {
const response = await fetch(GOOGLE_SHEET_URL, {
method: 'POST',
mode: 'no-cors',
cache: 'no-cache',
headers: {
'Content-Type': 'application/json'
},
body: JSON.stringify(data)
});

console.log("Percubaan penghantaran data ke Sheet selesai. Semak Google Sheet anda.");
return true;

} catch (error) {
console.error("Gagal menghantar data ke Google Sheet:", error);
alert("‚ö†Ô∏è Ralat: Gagal merekod order ke sheet. Sila hubungi Syamil.");
return false;
}
}

async function uploadReceiptToImgBB(fileObj) {
if (!fileObj) return "Tiada resit dimuat naik.";

return new Promise((resolve, reject) => {
const reader = new FileReader();
reader.readAsDataURL(fileObj);
reader.onload = async () => {
const base64Image = reader.result.split(',')[1];

const uploadFormData = new FormData();
uploadFormData.append("image", base64Image);
uploadFormData.append("name", `resit_${orderId}_${fileObj.name}`);

try {
const response = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, {
method: 'POST',
body: uploadFormData
});

const data = await response.json();

if (data && data.data && data.data.url) {
console.log("Resit berjaya dimuat naik. URL:", data.data.url);
resolve(data.data.url);
} else {
console.error("Gagal mendapat URL resit dari ImgBB:", data);
resolve(null);
}
} catch (error) {
console.error("Ralat rangkaian ketika memuat naik ke ImgBB:", error);
resolve(null);
}
};
reader.onerror = error => reject(error);
});
}

// ** FUNGSI MUAT TURUN QR CODE BARU (Kekal Sama) **
async function downloadQrCode() {
const currentQ = questions.find(q => parseInt(q.Field_ID) === step);
const qrCodeUrl = currentQ && currentQ.Options.trim() ? currentQ.Options.trim() : DUMMY_QR_CODE_URL;
const filename = 'QR_Pembayaran.jpg';

try {
const resp = await fetch(qrCodeUrl, { mode: 'cors', cache: 'no-cache' });
if (resp.ok) {
const blob = await resp.blob();
const blobType = blob.type || 'image/jpeg';
const objectUrl = URL.createObjectURL(new Blob([blob], { type: blobType }));

const a = document.createElement('a');
a.href = objectUrl;
a.download = filename;
document.body.appendChild(a);
a.click();
a.remove();
setTimeout(() => URL.revokeObjectURL(objectUrl), 1000);

alert('QR Code telah dimuat turun ke folder Muat Turun anda.');
return;
} else {
throw new Error('Fetch responded with non-OK status: ' + resp.status);
}
} catch (err) {
console.warn('Fetch blob gagal, cuba fallback canvas method:', err);
}

try {
await new Promise((resolve, reject) => {
const img = new Image();
img.crossOrigin = 'anonymous';
img.onload = () => {
try {
const canvas = document.createElement('canvas');
canvas.width = img.naturalWidth || img.width;
canvas.height = img.naturalHeight || img.height;
const ctx = canvas.getContext('2d');
ctx.drawImage(img, 0, 0);

canvas.toBlob((blob) => {
if (!blob) {
reject(new Error('canvas.toBlob returned null'));
return;
}
const objectUrl = URL.createObjectURL(blob);
const a = document.createElement('a');
a.href = objectUrl;
a.download = filename;
document.body.appendChild(a);
a.click();
a.remove();
setTimeout(() => URL.revokeObjectURL(objectUrl), 1000);
resolve();
}, 'image/jpeg', 0.95);
} catch (e) {
reject(e);
}
};
img.onerror = (e) => reject(e);
img.src = qrCodeUrl + (qrCodeUrl.indexOf('?') === -1 ? '?_=' : '&_=') + Date.now();
});
alert('QR Code telah disimpan (semak folder Muat Turun).');
return;
} catch (err) {
console.warn('Canvas fallback gagal:', err);
}

try {
window.open(qrCodeUrl, '_blank');
} catch (e) {
location.href = qrCodeUrl;
}

alert('Tidak dapat muat turun automatik pada peranti ini. Imej dibuka di tab baru ‚Äî tekan & tahan (atau ketuk) imej lalu pilih "Simpan Imej" untuk simpan ke galeri.');
}



// ** FUNGSI UTAMA CHATBOT **
async function nextStep() {
if (isProcessing) return;
isProcessing = true;

inputArea.innerHTML = '';

const currentQ = questions.find(q => parseInt(q.Field_ID) === step);

if (!currentQ && step <= questions.length) {
isProcessing = false;
return;
}

if (step > questions.length) {
// Ini adalah langkah terakhir (Case 6)
await addMessage(`Baik Order **${userData.name}** Diterima. Order anda sedang diproses.`, 'bot-message');
await addMessage(`Sebarang pertanyaan berhubung dengan Syamil (+60 10-527 2343).`, 'bot-message');

const whatsappMessage = `Assalamualaikum, saya ${userData.name} ingin bertanya mengenai tempahan baju saya (ID Order: ${orderId}).`;

inputArea.innerHTML = `
<a href="https://wa.me/60105272343?text=${encodeURIComponent(whatsappMessage)}" target="_blank" class="choice-button" style="background-color: #25D366; text-decoration: none; text-align: center; width: 100%;">
<span style="vertical-align: middle; margin-right: 5px;">üí¨‚Äãüìû</span>
WhatsApp Syamil
</a>
`;
isProcessing = false;
return;
}


if (step !== 1) {
showTypingIndicator();
await new Promise(r => setTimeout(r, 1500));
hideTypingIndicator();
}

// --- LOGIK MEMAPARKAN SOALAN DARI CSV ---
const questionText = currentQ.Question.replace(/{{name}}/g, userData.name);
await addMessage(questionText, 'bot-message');

switch (currentQ.Type) {
case 'text':
// Untuk Field_ID 1 (Nama) & 3 (Nombor Telefon)
const inputId = currentQ.Field_ID === '1' ? 'name-input' : 'phone-input';
const submitFn = currentQ.Field_ID === '1' ? 'submitName()' : 'submitPhone()';
const placeholder = currentQ.Field_ID === '1' ? 'Masukkan Nama Anda' : 'Masukkan Nombor Telefon';

inputArea.innerHTML = `
<input type="text" id="${inputId}" placeholder="${placeholder}" class="form-input" style="min-height: 40px; border-radius: 20px; padding: 10px 15px;">
<button onclick="${submitFn}"><span style="transform: rotate(0deg); display: block;">‚û§</span></button>
`;
document.getElementById(inputId).focus();
break;

case 'choices':
// Untuk Field_ID 2 (Saiz Baju)
const options = currentQ.Options.split(',').map(s => s.trim()).filter(s => s.length > 0);
const buttonHtml = options.map(opt => {
if (opt === 'Lain-lain') {
return `<button class="choice-button" onclick="toggleCustomSizeInput()">Lain Saiz (Isi)</button>`;
}
return `<button class="choice-button" onclick="addSizeInput('${opt}')">${opt}</button>`;
}).join('');

inputArea.innerHTML = `
<div id="size-options" style="width: 100%; margin-bottom: 10px; display: flex; flex-wrap: wrap; gap: 5px;">
${buttonHtml}
</div>
<div id="custom-size-area" style="width: 100%; display: none; margin-bottom: 10px;">
<input type="text" id="custom-size-input" placeholder="Isi saiz lain (cth: 4XL)" class="form-input" style="width: 100%;">
<input type="number" id="custom-qty-input" placeholder="Kuantiti" min="1" value="1" class="form-input" style="width: 100%;">
<button onclick="addCustomSize()" class="choice-button" style="width: 100%;">Tambah Saiz</button>
</div>
<div id="selected-sizes" style="width: 100%; margin-bottom: 10px;">
</div>
<button style="width: 100%;" onclick="submitSizes()">Sahkan Saiz dan Kuantiti</button>
`;
updateSelectedSizesDisplay();
break;

case 'image':
// Untuk Field_ID 4 (QR Code Pembayaran)
const qrCodeUrl = currentQ.Options.trim() ? currentQ.Options.trim() : DUMMY_QR_CODE_URL;

showTypingIndicator();
await preloadImage(qrCodeUrl);
hideTypingIndicator();

await addMessage(`Sila **imbas QR Code** di bawah:`, 'bot-message', 100);
await addMessage(`<img src="${qrCodeUrl}" alt="QR Code Pembayaran">`, 'bot-message', 100);

await addMessage(`Anda boleh **muat turun QR Code** ini untuk diimbas dari galeri telefon anda melalui aplikasi perbankan.`, 'bot-message', 100);

inputArea.innerHTML = `
<button onclick="downloadQrCode()" class="choice-button" style="background-color: #34B7F1; width: 100%; text-align: center;">‚¨áÔ∏è Muat Turun QR Code</button>

<div class="upload-area" style="width: 100%; margin-top: 5px; margin-bottom: 5px;">

<div style="display: flex; align-items: center; width: 100%; background-color: #fff; border: 1px solid #ccc; border-radius: 10px; overflow: hidden;">

<label for="receipt-upload" style="cursor: pointer; background-color: #f7f7f7; color: #000; padding: 8px 10px; font-weight: bold; font-size: 0.9em; border-right: 1px solid #ccc; flex-shrink: 0;">
Pilih Resit
</label>

<input type="file" id="receipt-upload" accept="image/*,application/pdf" style="display: none;">

<span id="file-name" style="font-size: 0.9em; padding-left: 10px; color: #555; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; flex-grow: 1;">Tiada fail dipilih.</span>

</div>

</div>

<button onclick="submitReceipt()" style="width: 100%;" class="choice-button">Sahkan Pembayaran / Skip</button>
`;
document.getElementById('receipt-upload').addEventListener('change', function(e) {
document.getElementById('file-name').textContent = e.target.files.length > 0 ? e.target.files[0].name : 'Tiada fail dipilih.';
});
break;

case 'upload':
// Logik upload telah disatukan ke dalam Case 4 (Image/QR Code)
// Jika anda ingin mengasingkan upload ke step 5, anda boleh ubah di sini.
// Mengikut flow CSV: upload ada di Field_ID 5.
// Kita telah skip Type 'upload' ini kerana ia telah disatukan di Step 4.
step++;
isProcessing = false;
nextStep(); // Skip step 5 dan teruskan ke step 6 (Confirm)
return;

case 'confirm':
// Untuk Field_ID 6 (Sahkan Order)
const sizeSummary = userData.sizeQty.map(item => {
const size = item.size === 'Lain-lain' ? `Lain: ${item.customSize}` : item.size;
return `**Saiz ${size}**: ${item.qty} unit`;
}).join('<br>');

// Paparkan ringkasan order
await addMessage(`
**Nama**: ${userData.name}<br>
**Saiz Baju dan Kuantiti**:<br>${sizeSummary}<br>
**Nombor Telefon**: ${userData.phone}<br>
**Resit Pembayaran**: ${uploadedReceiptUrl === 'Belum diterima' ? 'Belum diterima' : `<a href="${uploadedReceiptUrl}" target="_blank">Lihat Resit</a>`}
`, 'bot-message', 100);

inputArea.innerHTML = `
<button class="choice-button" onclick="confirmOrder(true)">Ya, Betul</button>
<button class="choice-button red" onclick="confirmOrder(false)">Tidak, Saya Mahu Mengeditnya</button>
`;
break;

default:
await addMessage(`Ralat: Jenis soalan tidak sah untuk Langkah ${step}.`, 'bot-message');
break;
}
isProcessing = false;
}

// ** FUNGSI PENGENDALIAN INPUT (Kekal Sama) **
function submitName() {
if (isProcessing) return;
const nameInput = document.getElementById('name-input');
const name = nameInput.value.trim();
if (name) {
userData.name = name;
addMessage(name, 'user-message', 10);
step++;
nextStep();
} else {
alert('Sila masukkan nama anda.');
}
}

function toggleCustomSizeInput() {
const customArea = document.getElementById('custom-size-area');
customArea.style.display = customArea.style.display === 'none' ? 'block' : 'none';
if (customArea.style.display === 'block') { document.getElementById('custom-size-input').focus(); }
}

function addSizeInput(size) {
let qty;
const inputQty = prompt(`Masukkan kuantiti untuk saiz ${size}:`, "1");
if (inputQty !== null) {
qty = parseInt(inputQty);
if (isNaN(qty) || qty < 1) { alert("Kuantiti tidak sah."); return; }
userData.sizeQty.push({ size: size, qty: qty });
updateSelectedSizesDisplay();
}
}

function addCustomSize() {
const size = document.getElementById('custom-size-input').value.trim();
const qty = parseInt(document.getElementById('custom-qty-input').value);
if (!size || isNaN(qty) || qty < 1) { alert("Sila isi saiz lain dan kuantiti yang sah."); return; }

userData.sizeQty.push({ size: 'Lain-lain', customSize: size, qty: qty });
document.getElementById('custom-size-input').value = "";
document.getElementById('custom-qty-input').value = "1";
toggleCustomSizeInput();
updateSelectedSizesDisplay();
}

function updateSelectedSizesDisplay() {
const selectedDiv = document.getElementById('selected-sizes');
if (userData.sizeQty.length > 0) {
selectedDiv.innerHTML = '<span style="font-weight: bold; display: block; margin-bottom: 5px;">Pilihan saiz anda:</span>' + userData.sizeQty.map((item, index) => {
const sizeText = item.size === 'Lain-lain' ? `Lain: ${item.customSize}` : item.size;
return `<span style="display: flex; justify-content: space-between; align-items: center; background-color: #f0f0f0; padding: 5px; border-radius: 5px; margin-bottom: 5px; font-size: 0.9em;">
${sizeText} - ${item.qty} unit
<button onclick="removeSize(${index})" style="background-color: #ff4d4d; color: white; border: none; padding: 2px 5px; border-radius: 3px; font-size: 0.8em;">X</button>
</span>`;
}).join('');
} else { selectedDiv.innerHTML = ''; }
chatBox.scrollTop = chatBox.scrollHeight;
}

function removeSize(index) {
userData.sizeQty.splice(index, 1);
updateSelectedSizesDisplay();
}

function submitSizes() {
if (isProcessing) return;
if (userData.sizeQty.length > 0) {
const summary = userData.sizeQty.map(item => {
const size = item.size === 'Lain-lain' ? `Lain: ${item.customSize}` : item.size;
return `${size} (${item.qty} unit)`;
}).join(', ');
addMessage(`Saiz dan Kuantiti: ${summary}`, 'user-message', 10);
step++;
nextStep();
} else { alert('Sila pilih sekurang-kurangnya satu saiz dan kuantiti.'); }
}

function submitPhone() {
if (isProcessing) return;
const phoneInput = document.getElementById('phone-input');
const phone = phoneInput.value.trim();
if (phone && /^\+?[0-9\s-]{7,15}$/.test(phone)) {
userData.phone = phone;
addMessage(phone, 'user-message', 10);
step++;
nextStep();
} else { alert('Sila masukkan nombor telefon yang sah.'); }
}

async function submitReceipt() {
if (isProcessing) return;
isProcessing = true;

const fileInput = document.getElementById('receipt-upload');
const file = fileInput.files[0];

let userMessageText = "Resit: ";

if (file) {
userMessageText += `${file.name} sedang dimuat naik...`;
addMessage(userMessageText, 'user-message', 10);

showTypingIndicator();
const url = await uploadReceiptToImgBB(file);
hideTypingIndicator();

if (url) {
uploadedReceiptUrl = url;
addMessage(`‚úÖ Resit berjaya dimuat naik: <a href="${url}" target="_blank">Lihat Resit</a>`, 'bot-message', 100);
} else {
uploadedReceiptUrl = "Gagal Muat Naik Resit";
addMessage('‚ö†Ô∏è Gagal muat naik resit. Akan direkod sebagai "Belum diterima".', 'bot-message', 100);
}
} else {
userMessageText += "Tiada resit di *upload* (Sila lengkapkan pembayaran nanti).";
addMessage(userMessageText, 'user-message', 10);
uploadedReceiptUrl = "Belum diterima";
}

isProcessing = false;
step++; // Pindah ke langkah 'confirm'
nextStep();
}

async function confirmOrder(isConfirmed) {
if (isProcessing) return;
if (isConfirmed) {
addMessage('Ya, Betul', 'user-message', 10);

const finalOrderData = formatOrderDataForSheet(userData);

showTypingIndicator();
await sendDataToSheet(finalOrderData);
hideTypingIndicator();

step++;
nextStep();
} else {
addMessage('Tidak, Saya Mahu Mengeditnya', 'user-message', 10);

userData.sizeQty = [];
userData.phone = "";
uploadedReceiptUrl = "Belum diterima";
step = 1;

addMessage(`Baik **${userData.name}**, kita kembali ke soalan pertama untuk edit order.`, 'bot-message', 500).then(() => {
nextStep();
});
}
}

// ** INICIALISASI **
window.onload = async function() {
// Cuba ambil soalan dari CSV terlebih dahulu
questions = await fetchQuestions();

if (questions.length > 0) {
// Mulakan proses chatbot
nextStep();
} else {
// Paparkan ralat jika gagal
addMessage('‚ö†Ô∏è Ralat kritikal: Gagal memuatkan soalan order. Sila cuba muat semula laman.', 'bot-message', 10);
}
};
</script>

</body>
</html>----
